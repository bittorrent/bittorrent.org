<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.14: http://docutils.sourceforge.net/" />
<title>bep_0011.rst_post</title>
<meta name="author" content="The 8472 &lt;the8472.bep&#64;infinite-source.de&gt;" />
<link rel="stylesheet" href="../css/bep.css" type="text/css" />
</head>
<body>
<div class="document">

<div id="upper" class="clear">
<div id="wrap">
<div id="header">
<h1><a href="../index.html">BitTorrent<span>.org</span></a></h1>
</div>
<div id="nav">
<ul>
<li><a href="../index.html">Home</a></li>
<li><a href="../introduction.html">For Users</a></li>
<li><a href="bep_0000.html"><span>For Developers</span></a></li>
<li><a href="../mailing_list.html">Developer mailing list</a> </li>
<li><a href="http://forum.bittorrent.org"> Forums (archive) </a></li>
</ul>
</div> <!-- nav -->
<!-- ### Begin Content ### -->
<div id="second">


<table class="docinfo" frame="void" rules="none">
<col class="docinfo-name" />
<col class="docinfo-content" />
<tbody valign="top">
<tr class="bep field"><th class="docinfo-name">BEP:</th><td class="field-body">11</td>
</tr>
<tr class="title field"><th class="docinfo-name">Title:</th><td class="field-body">Peer Exchange (PEX)</td>
</tr>
<tr><th class="docinfo-name">Version:</th>
<td>7ad40d1b62068015b7b846e7d248f3770d0e9b6a</td></tr>
<tr class="last-modified field"><th class="docinfo-name">Last-Modified:</th><td class="field-body">Tue Sep 26 11:16:44 2017 +0200</td>
</tr>
<tr><th class="docinfo-name">Author:</th>
<td>The 8472 &lt;<a class="reference external" href="mailto:the8472&#46;bep&#37;&#52;&#48;infinite-source&#46;de">the8472<span>&#46;</span>bep<span>&#64;</span>infinite-source<span>&#46;</span>de</a>&gt;</td></tr>
<tr><th class="docinfo-name">Status:</th>
<td>Accepted</td></tr>
<tr class="type field"><th class="docinfo-name">Type:</th><td class="field-body">Standards Track</td>
</tr>
<tr class="created field"><th class="docinfo-name">Created:</th><td class="field-body">29-Oct-2015</td>
</tr>
<tr class="depends field"><th class="docinfo-name">Depends:</th><td class="field-body">10</td>
</tr>
<tr class="post-history field"><th class="docinfo-name">Post-History:</th><td class="field-body">22-Sep-2017 (<a class="reference external" href="mailto:the8472&#46;bep&#37;&#52;&#48;infinite-source&#46;de">the8472<span>&#46;</span>bep<span>&#64;</span>infinite-source<span>&#46;</span>de</a>), add section on handling swarm configurations that lead to underpopulated pex lists</td>
</tr>
</tbody>
</table>
<p>Peer Exchange (PEX) provides an alternative peer discovery mechanism for swarms once peers have bootstrapped via other mechanisms such as DHT or Tracker announces.</p>
<p>It provides a more up-to-date view of the swarm than most other sources and also reduces the need to query other sources frequently.</p>
<p>When combined with BEP 40 <a class="footnote-reference" href="#bep-40" id="id1">[1]</a> it provides a way to quickly randomize the connection graph of a swarm.</p>
<div class="section" id="protocol-extension">
<h1>Protocol Extension</h1>
<p>PEX introduces a new message <tt class="docutils literal">ut_pex</tt> via the extension protocol <a class="footnote-reference" href="#bep-10" id="id2">[2]</a>.</p>
<p>added message negotiated in the handshake:</p>
<pre class="literal-block">
{
  m: {
    ut_pex: <em>&lt;implementation-dependent local message ID (positive integer)&gt;</em>,
    ...
  },
  ...
}
</pre>
<p>The extension message itself consists of the bittorrent/extension message header and the following bencoded payload:</p>
<pre class="literal-block">
{
  added: <em>&lt;one or more contacts in IPv4 compact format (string)&gt;</em>
  added.f: <em>&lt;optional, bit-flags, 1 byte per added IPv4 peer (string)&gt;</em>
  added6: <em>&lt;one or more contacts IPv6 compact format (string)&gt;</em>,
  added6.f: <em>&lt;optional, bit-flags, 1 byte per added IPv6 peer (string)&gt;</em>,
  dropped: <em>&lt;one or more contacts in IPv6 compact format (string)&gt;</em>,
  dropped6: <em>&lt;one or more contacts in IPv6 compact format (string)&gt;</em>
}
</pre>
<p>Flags are defined as follows:</p>
<blockquote>
<table border="1" class="docutils">
<colgroup>
<col width="5%" />
<col width="95%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Bit</th>
<th class="head">when set</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>0x01</td>
<td>prefers encryption, as indicated by <tt class="docutils literal">e</tt> field in extension handshake</td>
</tr>
<tr><td>0x02</td>
<td>seed/upload_only</td>
</tr>
<tr><td>0x04</td>
<td>supports uTP</td>
</tr>
<tr><td>0x08</td>
<td>peer indicated <tt class="docutils literal">ut_holepunch</tt> support in extension handshake</td>
</tr>
<tr><td>0x10</td>
<td>outgoing connection, peer is reachable</td>
</tr>
</tbody>
</table>
</blockquote>
<p>Other bits are reserved for future use. Implementors should submit a request to amend this BEP if they intend to introduce a new flag.</p>
<p>A peer must only be included in an <tt class="docutils literal">added</tt> field once a connection is successfully established and included in the <tt class="docutils literal">dropped</tt> field once it is disconnected.
Once a peer has been <tt class="docutils literal">added</tt> a client must ensure to send the corresponding <tt class="docutils literal">dropped</tt> event when appropriate. Only signaling added peers without ever dropping them is non-compliant behavior.</p>
<blockquote>
<p><strong>Rationale</strong>: PEX is intended to reflect which peers a client is <em>currently connected to</em>, this ensures that PEX provides better liveness information than other peer discovery mechanisms.</p>
<p><strong>Rationale 2</strong>: Only propagating verified peers reduces the opportunity for attackers to abuse bittorrent swarms for distributed denial-of-service attacks.</p>
</blockquote>
<p>Clients must batch updates to send no more than 1 PEX message per minute.</p>
<p>It is not required to send a PEX message immediately after a handshake, e.g. during torrent startup a client may wait until it has established enough connections to make sending pex messages worthwhile.</p>
<p>Added or removed contacts must not contain duplicates.</p>
<p>Transient connect-disconnect or disconnect-reconnect events may be elided between update messages as long as it does not affect the correctness.</p>
<blockquote>
<strong>Implementation Note</strong>: A simple approach is to queue up not-yet-sent connect/disconnect events for each connected peer and performing elision when generating the message. An slightly more complex but more memory-efficient approach is to keep a per-torrent timeline of connect/disconnect events and simply store a pointer for the point in time up to which events have already been sent for each peer. When creating a PEX message they only need to advance the pointer, take care to eliminate duplicates and to elide transient connections.</blockquote>
<p>An added contact must not be dropped in the same message.</p>
<p>Except for the initial PEX message the combined amount of added v4/v6 contacts should not exceed 50 entries. The same applies to dropped entries.</p>
<p>Messages must contain at least one of the following fields: <tt class="docutils literal">added, added6, dropped, dropped6</tt>.</p>
<p>Clients may disconnect peers that egregiously violate these constraints.</p>
</div>
<div class="section" id="filling-underpopulated-lists">
<h1>Filling underpopulated lists</h1>
<p>A combination of the</p>
<ul class="simple">
<li>above liveness requirements</li>
<li>disconnecting seeds or partial seeds <a class="footnote-reference" href="#bep-21" id="id3">[3]</a> while seeding</li>
<li>disconnecting duplicate peers based on peer IDs between ipv4 and ipv6</li>
</ul>
<p>can lead to underpopulated <tt class="docutils literal">added</tt> or <tt class="docutils literal">added6</tt> lists. This problem frequently arises in swarms dominated by seeds where the seeds have no live connections to propagate and the peers
only have seeds they can propagate to other seeds, dramatically reducing PEX's effectiveness.
Similarly this can make it difficult to obtain ipv6 peers in an ipv4 dominated swarm because ipv6 connections will be considered duplicates of already-established v4 ones, thus preventing their propagation via PEX.</p>
<p>To remedy these issues the liveness requirement is relaxed if a client is connected to less than 25 clients for a particular address family.
In that situation it may keep a list of up to 25 most recently established and <em>fully handshaken</em> connections for that address family and record the disconnect reason for those connections.
The following reasons for locally initiated disconnects qualify a remote contact for inclusion in the in the <tt class="docutils literal">added</tt> or <tt class="docutils literal">added6</tt> lists:</p>
<ul class="simple">
<li>the same peer ID was already connected under a different address family</li>
<li>permanent lack of mutual interest, e.g. inferred from (partial) seed status and piece availability</li>
<li>local resource limits such as a global connection counts were exceeded</li>
</ul>
<p>When including such a recently disconnected contact in a pex message it must be drained from the recently seen list so it will not be sent again in the next message.
When the list gets repopulated through transient connect-disconnect events those may be included in the next message if all necessary conditions are fulfilled.
In other words in addition to populating the initial pex message from the recently seen list a client may effectively also skip some of the connect-disconnect elisions.</p>
<p>But since recently seen contacts do not represent live connections they must be dropped with the next PEX message.</p>
<p>The restriction that the same address must not be added and dropped within the same message must still be maintained.</p>
<p>The requirement of less than 25 live connections and limit of 25 recently seen ones is chosen so that at most two pex messages worth of droppable contacts can accumulate and that no stale information is sent when there are enough live contacts to populate pex messages.</p>
<p>Note that this exemption can be applied separately for IPv4 and IPv6. I.e. even if there are enough v4 live contacts a client may still include recently seen v6 contacts or vice versa if the respective lists would be underpopulated.</p>
</div>
<div class="section" id="security-considerations">
<h1>Security Considerations</h1>
<p>Data exchanged via PEX messages should be considered untrusted and potentially malicious.</p>
<p>An attacker might try to sabotage a swarm by flooding it with bogus or other uncooperative peers.</p>
<p>PEX may also be used to cause a distributed denial of service attack by inducing bittorrent clients to perform connection attempts to victim IP ranges.</p>
<p>To mitigate these a client should avoid taking all its connection candidates from a single PEX source. Duplicate IP addresses (e.g. with different ports) should be ignored. Additionally Canonical Peer Priority <a class="footnote-reference" href="#bep-40" id="id4">[1]</a> can help spreading connection attempts over many subnets, thus reducing the impact on any potential victim subnet.</p>
</div>
<div class="section" id="references">
<h1>References</h1>
<table class="docutils footnote" frame="void" id="bep-40" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[1]</td><td><em>(<a class="fn-backref" href="#id1">1</a>, <a class="fn-backref" href="#id4">2</a>)</em> <p>BEP 40, &quot;Canonical Peer Priority&quot;</p>
<p class="last"><a class="reference external" href="http://bittorrent.org/beps/bep_0040.html">http://bittorrent.org/beps/bep_0040.html</a></p>
</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="bep-10" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><p class="first">BEP 10, &quot;Extension Protocol&quot;</p>
<p class="last"><a class="reference external" href="http://bittorrent.org/beps/bep_0010.html">http://bittorrent.org/beps/bep_0010.html</a></p>
</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="bep-21" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td><p class="first">BEP 21, &quot;Extension for partial seeds&quot;</p>
<p class="last"><a class="reference external" href="http://bittorrent.org/beps/bep_0021.html">http://bittorrent.org/beps/bep_0021.html</a></p>
</td></tr>
</tbody>
</table>
</div>
<div class="section" id="copyright">
<h1>Copyright</h1>
<p>This document has been placed in the public domain.</p>
</div>

</div>
	<div id="footer">
<hr/>
</div>

</div>
</body>
</html>
